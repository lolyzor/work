 <!DOCTYPE html>
<html>
<head>
    <title>Elaw.my</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="css/jquery.mobile-1.3.0.min.css" />
    <script src="js/jquery-1.8.2.min.js"></script>
    <script src="js/jquery.mobile-1.3.0.min.js"></script>
    <script>
    </script>
   
</head>
<body>
 <div data-role="page" id="caseMain">

        <div data-role="header" data-position="fixed" data-id="header1" data-tap-toggle="false">
            <h1 data-theme="e">Elaw.my</h1>
            <a id="linkback" href="searchItems.html" data-icon="arrow-l" data-theme="b">Back</a>
            <a href="index.html" data-icon="gear" class="ui-btn-right" data-theme="b">Home</a>  
        </div><!-- /header -->
         <div data-role="content">
           <div id="results">
           	
           </div>
       </div> <!-- ending content -->
        <div data-role="footer" data-tap-toggle="false" data-id="footer1" data-position="fixed">        
            <div data-role="navbar">
                <ul id="footerList">
                    <li><a link="latest.html" data-icon="star">Latest</a></li>
                    <li><a link="caseSearch.html" data-icon="search" class="" id="caseSearchLink" data-theme="b">Cases</a></li>
                    <li><a link="legislationSearch.html" data-icon="search">Legislation</a></li>
                    <li><a href="#popupMenu" data-rel="popup" data-role="button" data-inline="true" data-icon="gear">More</a></li>
                </ul>
            </div><!-- /navbar -->
        </div><!-- /footer --> 
         <div data-role="popup" id="popupMenu" id="footerlist2">
            <ul data-role="listview" data-inset="true" style="min-width:210px;">
                <li><a href="#searchPopUp" data-rel="popup" data-position-to="window">Search</a></li>
                <li><a href="references.html">References</a></li>
                <li><a href="help.html">Help</a></li>                            
            </ul>
        </div>        
         <div data-role="popup" id="searchPopUp">
                <div style="padding:10px 20px;">
                    <input data-mini="true" id="searchText" name="search" type="text">
                    <button id="nextSearch" data-mini="true" data-inline="true">next</button>
                    <button id="prevSearch" data-mini="true" data-inline="true">prev</button>
                    <button id="closeSearchBox" data-mini="true" data-inline="true">Close</button>
                </div>
        </div><!--end of searchPopup --!>
    <style>
        .found{
            background-color: Yellow;
            font: inherit;
            }
         .currentFound {
            background-color: orange;
            }
        div.ui-btn {
            padding-top:1px;
            padding-bottom:1px;
            margin-top:1px;
            margin-bottom:1px;
        }
        #results p {
            text-align:justify;
        }
    </style> 
    <script>
        function replaceAll(find, replace, str) {
          return str.replace(new RegExp(find, 'g'), replace);
        }
        $('button').on('vclick',function(){
            //console.log($(this).attr('id'));
            var options = $(this).attr('id');
            if(options == 'nextSearch' || options == 'prevSearch'){
                var query = $("#searchText").val(); 
                $.trim(query);
                if(query){
                    $("#searchPopUp").popup("close");
                    searchIt(query,options);
                }
            }
            if($(this).attr('id')=='closeSearchBox'){
                $("#searchPopUp").popup("close");
                //$.searchQuery = false;
                //remTags();
            }
            //return false;
        });
        function showSearchBox() {
            $("#searchPopUp").popup("open");
        }
        function callback(match, p1) {
            return ((p1 == undefined) || (p1 == '')) ? match : '<span class="found">' + match + '</span>';
        }
        function surroundTags(search) {
              $('#results').html($('#results').html().replace(new RegExp("<[^>]+>|&nbsp;|&amp;|(" + search + ")", 'ig'), callback));
        }
        function remTags() {
            $('.found').contents().unwrap();
        }
        function searchIt(query,options){
            var newSearch = false;
            if(!$.searchQuery){
                $.searchQuery = query
                newSearch = true;
            }
            else{
                if($.searchQuery != query){
                    remTags();
                    $.searchQuery = query;
                    newSearch = true;
                }
            }
            if(newSearch){
                console.log("new search");
                surroundTags($.searchQuery);
                if($('.found').size()){
                    $.fndsz = $('.found').size();
                    if(options=='prevSearch'){
                        $.curr = $.fndSz - 1;
                        var X = $('.found:eq(' + $.curr + ')').offset().top;
                        //$('body,html').animate({ scrollTop: X - 50 });
                        $.mobile.silentScroll(X);
                        $('.found:eq(' + $.curr + ')').addClass('currentFound');
                        setTimeout(showSearchBox,250);
                    }
                    else{
                        var X = $('.found:eq(0)').offset().top;
                        //$('body,html').animate({ scrollTop: X - 50});
                        $.mobile.silentScroll(X);
                        $('.found:eq(0)').addClass('currentFound');
                        setTimeout(showSearchBox,250);
                    }
                }
            }
            else{
                if(!$.curr){
                    $.curr = 0;
                }
            if ($('.found').size()) {
                //jump to the next/prev and add currentFound class + remove the prev class
                $('.found:eq(' + $.curr + ')').removeClass('currentFound');
                if (options=='prevSearch') {
                    $.curr = (--$.curr);
                    if ($.curr < 0)
                        $.curr = $.fndsz - 1;
                } else
                    $.curr = (++$.curr) % $.fndsz;
                var X = $('.found:eq(' + $.curr + ')').offset().top;
                //$('body,html').animate({ scrollTop: X - 50 });
                $.mobile.silentScroll(X);
                $('.found:eq(' + $.curr + ')').addClass('currentFound');
                setTimeout(showSearchBox,250);
            }
        }
    }
    $("#caseMain li a").on('vclick',function(){
        //console.log();
        var url = $(this).attr('link');
        if(url)
            $.mobile.changePage(url);
    });
    function pageZero(){
        //load the whole page at once !
        var filename = $.filename;
        var url = 'http://elaw.com.my/Elawf4/mobile/searchresultmobile.aspx?filename='+filename;
        var page = '';
        $.casePage += 1;
        page = $.casePage;           
        url += '&p=0';
        url += '&callback=?';
        //console.log(url);
        return url;
    }
    function makeUrl(p){
        var filename = $.filename;
        //var ec = $.urlParam('ec');
        var url = 'http://elaw.com.my/Elawf4/mobile/searchresultmobile.aspx?filename='+filename;
        var page = '';
        $.casePage += 1;
        page = $.casePage;           
        url += '&p='+page;
        url += '&callback=?';
        //console.log(url);
        return url;
    }
    function runIt(){
        $.casePage = 0;
        $.scrollAndLoad = true;
        var urltext = pageZero();
        $.mobile.loading('show');
        $.getJson(urltext,'caseMain');
        $(window).on('scroll',function(){
            if($.mobile.activePage.attr('id') == 'caseMain'){
                if($(window).scrollTop() + $(window).height() >= $(document).height()){
                    if($.scrollAndLoad){                
                        url = makeUrl();
                        console.log(url);
                        if($.casePage <= $.lastPage){
                            $.getJson(url,'caseMain');
                            $.mobile.loading('show');
                        }                        
                        $.scrollAndLoad = false;
                        //$(window).height() -= 20;
                        
                    }                
                }
            }    
        });
    }
    function runIt2(){
        $.fx.off = true;
        if($.latest){
            $("#linkback").attr('href','latest.html');
            $.latest=false;
        }
        if($.citationSearch){
            $("#linkback").attr('href','caseSearch.html');
            $.citationSearch=false;
        }
        $("li a").on("vclick",function(){
            $$ = $(this);
            if ($$.attr('popup')=='true'){
                console.log("true");
                //$("#searchPopUp").toggle(true);
                $("#searchPopUp").popup("reposition",{x:0,y:60});
            }
        });
    }
    $('#caseMain').on('pageshow', runIt);  
    $('#caseMain').on('pageinit', runIt2);  
    </script>
    </div>
</body>
<html>
